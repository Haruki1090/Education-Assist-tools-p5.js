<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªã‚°ãƒ©ãƒ•æç”»ãƒ„ãƒ¼ãƒ«</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Helvetica Neue', Arial, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .content {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .graph-container {
            flex: 1 1 65%;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            overflow: hidden;
            position: relative;
        }
        
        .canvas-container {
            width: 100%;
            height: 500px;
            position: relative;
            overflow: hidden;
        }
        
        .tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            pointer-events: none;
            font-size: 14px;
            z-index: 100;
            display: none;
        }
        
        .controls {
            flex: 1 1 30%;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            overflow-y: auto;
            max-height: 650px;
        }
        
        .control-group {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        h2 {
            color: #3498db;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input[type="range"] {
            width: 100%;
            margin-bottom: 10px;
        }
        
        select, input[type="text"], input[type="number"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button.active {
            background-color: #2c3e50;
        }
        
        button.danger {
            background-color: #e74c3c;
        }
        
        button.danger:hover {
            background-color: #c0392b;
        }
        
        .parameter-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .parameter-label {
            width: 30px;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .parameter-range {
            flex: 1;
            margin-right: 10px;
        }
        
        .parameter-value {
            width: 50px;
            text-align: right;
        }
        
        .function-list {
            margin-bottom: 15px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .function-item {
            padding: 10px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
        }
        
        .function-item:hover {
            background-color: #f5f5f5;
        }
        
        .function-item.active {
            background-color: #e1f5fe;
            font-weight: bold;
        }
        
        .function-item:last-child {
            border-bottom: none;
        }
        
        .function-color {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .function-actions {
            display: flex;
        }
        
        .function-action {
            cursor: pointer;
            margin-left: 10px;
            color: #777;
        }
        
        .function-action:hover {
            color: #333;
        }
        
        .color-picker {
            margin-bottom: 15px;
        }
        
        .range-wrapper {
            margin-bottom: 15px;
        }
        
        .range-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .range-col {
            flex: 1;
        }
        
        .info-message {
            margin-top: 15px;
            padding: 10px;
            background-color: #e1f5fe;
            border-left: 4px solid #03a9f4;
            margin-bottom: 15px;
        }
        
        .animation-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .animation-parameter {
            margin-top: 10px;
            display: flex;
            align-items: center;
        }
        
        .animation-parameter label {
            margin-right: 10px;
            margin-bottom: 0;
        }
        
        .graph-options {
            margin-bottom: 20px;
        }
        
        .option-checkbox {
            margin-right: 10px;
        }
        
        .color-picker input {
            width: 30px;
            height: 30px;
            margin: 0;
            padding: 0;
            border: none;
        }
        
        .function-equation {
            font-family: 'Courier New', monospace;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 18px;
        }
        
        .animation-speed-container {
            margin-top: 10px;
        }
        
        .visualization-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .responsive-info {
            display: none;
            padding: 15px;
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            margin-bottom: 15px;
        }
        
        @media (max-width: 768px) {
            .content {
                flex-direction: column;
            }
            
            .controls {
                max-height: none;
                order: 2;
            }
            
            .graph-container {
                order: 1;
            }
            
            .responsive-info {
                display: block;
            }
            
            .canvas-container {
                height: 350px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªã‚°ãƒ©ãƒ•æç”»ãƒ„ãƒ¼ãƒ«</h1>
            <p>é–¢æ•°ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’èª¿æ•´ã—ã¦ã€ã‚°ãƒ©ãƒ•ã®å¤‰åŒ–ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç¢ºèªã—ã¾ã—ã‚‡ã†</p>
        </header>
        
        <div class="content">
            <div class="graph-container">
                <div class="graph-options">
                    <button id="toggleGrid" class="active">ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤º</button>
                    <button id="toggleAxes" class="active">è»¸è¡¨ç¤º</button>
                    <button id="toggleLabels" class="active">ãƒ©ãƒ™ãƒ«è¡¨ç¤º</button>
                    <button id="resetView">è¡¨ç¤ºãƒªã‚»ãƒƒãƒˆ</button>
                </div>
                <div class="canvas-container" id="canvas-container">
                    <div class="tooltip" id="tooltip"></div>
                </div>
            </div>
            
            <div class="controls">
                <div class="responsive-info">
                    ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã§ã®è¡¨ç¤ºã§ã¯ã€æœ€é©ãªä½“é¨“ã®ãŸã‚ã«ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã¸ã®åˆ‡ã‚Šæ›¿ãˆã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚
                </div>
                
                <div class="control-group">
                    <h2>é–¢æ•°ç®¡ç†</h2>
                    <div class="function-list" id="function-list">
                        <!-- é–¢æ•°ãƒªã‚¹ãƒˆãŒå‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
                    </div>
                    <button id="add-function">é–¢æ•°ã‚’è¿½åŠ </button>
                    <button id="remove-function" class="danger">é¸æŠã—ãŸé–¢æ•°ã‚’å‰Šé™¤</button>
                </div>
                
                <div class="control-group" id="function-controls">
                    <h2>é–¢æ•°ã®è¨­å®š</h2>
                    <div id="no-function-selected" style="display: none;">
                        <p>è¨­å®šã™ã‚‹é–¢æ•°ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
                    </div>
                    
                    <div id="function-settings">
                        <div class="function-equation" id="function-equation">f(x) = x</div>
                        
                        <h3>é–¢æ•°ã‚¿ã‚¤ãƒ—</h3>
                        <select id="function-type">
                            <option value="linear">ä¸€æ¬¡é–¢æ•° (y = ax + b)</option>
                            <option value="quadratic">äºŒæ¬¡é–¢æ•° (y = axÂ² + bx + c)</option>
                            <option value="cubic">ä¸‰æ¬¡é–¢æ•° (y = axÂ³ + bxÂ² + cx + d)</option>
                            <option value="sine">æ­£å¼¦é–¢æ•° (y = aÂ·sin(bx + c) + d)</option>
                            <option value="cosine">ä½™å¼¦é–¢æ•° (y = aÂ·cos(bx + c) + d)</option>
                            <option value="exponential">æŒ‡æ•°é–¢æ•° (y = aÂ·e^(bx) + c)</option>
                            <option value="logarithmic">å¯¾æ•°é–¢æ•° (y = aÂ·log(bx) + c)</option>
                            <option value="custom">ã‚«ã‚¹ã‚¿ãƒ é–¢æ•°</option>
                        </select>
                        
                        <div id="custom-function-input" style="display: none;">
                            <h3>ã‚«ã‚¹ã‚¿ãƒ é–¢æ•°å¼</h3>
                            <input type="text" id="custom-expression" placeholder="ä¾‹: 2*sin(x) + x^2/10">
                            <button id="apply-custom">é©ç”¨</button>
                            <div class="info-message">
                                å¤‰æ•°ã¯ã€Œxã€ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚sin, cos, tan, sqrt, log, exp ç­‰ã®æ•°å­¦é–¢æ•°ãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚
                            </div>
                        </div>
                        
                        <h3>ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´</h3>
                        <div id="parameter-controls">
                            <!-- ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãŒå‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
                        </div>
                        
                        <h3>å¤–è¦³</h3>
                        <div class="color-picker">
                            <label for="function-color">ç·šã®è‰²:</label>
                            <input type="color" id="function-color" value="#3498db">
                        </div>
                        
                        <div class="visualization-options">
                            <label>
                                <input type="checkbox" id="show-points" class="option-checkbox">
                                ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤º
                            </label>
                            <label>
                                <input type="checkbox" id="show-tangent" class="option-checkbox">
                                æ¥ç·šè¡¨ç¤º
                            </label>
                            <label>
                                <input type="checkbox" id="fill-area" class="option-checkbox">
                                é¢ç©å¡—ã‚Šã¤ã¶ã—
                            </label>
                        </div>
                        
                        <div class="animation-controls">
                            <button id="animate-button">ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹</button>
                            <button id="stop-animation">åœæ­¢</button>
                        </div>
                        
                        <div class="animation-parameter">
                            <label for="animate-param">ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:</label>
                            <select id="animate-param">
                                <option value="a">a</option>
                                <option value="b">b</option>
                                <option value="c">c</option>
                                <option value="d">d</option>
                            </select>
                        </div>
                        
                        <div class="animation-speed-container">
                            <label for="animation-speed">é€Ÿåº¦:</label>
                            <input type="range" id="animation-speed" min="1" max="10" value="5">
                        </div>
                    </div>
                </div>
                
                <div class="control-group">
                    <h2>ã‚°ãƒ©ãƒ•ç¯„å›²è¨­å®š</h2>
                    <div class="range-wrapper">
                        <div class="range-row">
                            <div class="range-col">
                                <label for="x-min">Xæœ€å°å€¤:</label>
                                <input type="number" id="x-min" value="-10" step="1">
                            </div>
                            <div class="range-col">
                                <label for="x-max">Xæœ€å¤§å€¤:</label>
                                <input type="number" id="x-max" value="10" step="1">
                            </div>
                        </div>
                        <div class="range-row">
                            <div class="range-col">
                                <label for="y-min">Yæœ€å°å€¤:</label>
                                <input type="number" id="y-min" value="-10" step="1">
                            </div>
                            <div class="range-col">
                                <label for="y-max">Yæœ€å¤§å€¤:</label>
                                <input type="number" id="y-max" value="10" step="1">
                            </div>
                        </div>
                        <button id="apply-range">ç¯„å›²ã‚’é©ç”¨</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let canvas;
        let functions = [];
        let selectedFunctionIndex = -1;
        let xMin = -10;
        let xMax = 10;
        let yMin = -10;
        let yMax = 10;
        let offsetX = 0;
        let offsetY = 0;
        let zoomLevel = 1;
        let isDragging = false;
        let lastMouseX = 0;
        let lastMouseY = 0;
        let showGrid = true;
        let showAxes = true;
        let showLabels = true;
        let isAnimating = false;
        let animationParameter = 'a';
        let animationSpeed = 5;
        let animationDirection = 1;
        
        // é–¢æ•°ã®è‰²ãƒªã‚¹ãƒˆ
        const colorList = [
            '#3498db', // é’
            '#e74c3c', // èµ¤
            '#2ecc71', // ç·‘
            '#f39c12', // ã‚ªãƒ¬ãƒ³ã‚¸
            '#9b59b6', // ç´«
            '#1abc9c', // ã‚¿ãƒ¼ã‚³ã‚¤ã‚º
            '#d35400', // æ·±ã‚ªãƒ¬ãƒ³ã‚¸
            '#34495e', // ç´º
            '#7f8c8d', // ã‚°ãƒ¬ãƒ¼
            '#c0392b', // ãƒ€ãƒ¼ã‚¯ãƒ¬ãƒƒãƒ‰
            '#16a085', // æ·±ç·‘
            '#f1c40f', // é»„è‰²
        ];
        
        // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ç¯„å›²å®šç¾©
        const parameterRanges = {
            linear: {
                a: { min: -5, max: 5, step: 0.1, default: 1 },
                b: { min: -10, max: 10, step: 0.1, default: 0 }
            },
            quadratic: {
                a: { min: -2, max: 2, step: 0.1, default: 1 },
                b: { min: -5, max: 5, step: 0.1, default: 0 },
                c: { min: -10, max: 10, step: 0.1, default: 0 }
            },
            cubic: {
                a: { min: -1, max: 1, step: 0.1, default: 1 },
                b: { min: -2, max: 2, step: 0.1, default: 0 },
                c: { min: -5, max: 5, step: 0.1, default: 0 },
                d: { min: -10, max: 10, step: 0.1, default: 0 }
            },
            sine: {
                a: { min: -5, max: 5, step: 0.1, default: 1 },
                b: { min: 0.1, max: 5, step: 0.1, default: 1 },
                c: { min: -Math.PI, max: Math.PI, step: 0.1, default: 0 },
                d: { min: -5, max: 5, step: 0.1, default: 0 }
            },
            cosine: {
                a: { min: -5, max: 5, step: 0.1, default: 1 },
                b: { min: 0.1, max: 5, step: 0.1, default: 1 },
                c: { min: -Math.PI, max: Math.PI, step: 0.1, default: 0 },
                d: { min: -5, max: 5, step: 0.1, default: 0 }
            },
            exponential: {
                a: { min: -5, max: 5, step: 0.1, default: 1 },
                b: { min: -2, max: 2, step: 0.1, default: 1 },
                c: { min: -10, max: 10, step: 0.1, default: 0 }
            },
            logarithmic: {
                a: { min: -5, max: 5, step: 0.1, default: 1 },
                b: { min: 0.1, max: 5, step: 0.1, default: 1 },
                c: { min: -10, max: 10, step: 0.1, default: 0 }
            }
        };
        
        // p5.js setupé–¢æ•°
        function setup() {
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®è¨­å®š
            const canvasContainer = document.getElementById('canvas-container');
            canvas = createCanvas(canvasContainer.offsetWidth, canvasContainer.offsetHeight);
            canvas.parent('canvas-container');
            
            // åˆæœŸé–¢æ•°ã‚’è¿½åŠ 
            addFunction('linear', { a: 1, b: 0 }, colorList[0]);
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
            setupEventListeners();
            
            // åˆæœŸé–¢æ•°ã®é¸æŠ
            selectFunction(0);
            updateFunctionsList();
        }
        
        // p5.js drawé–¢æ•°
        function draw() {
            background(255);
            
            // ã‚°ãƒªãƒƒãƒ‰ã¨è»¸ã®æç”»
            if (showGrid) drawGrid();
            if (showAxes) drawAxes();
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®æ›´æ–°
            if (isAnimating && selectedFunctionIndex !== -1) {
                updateAnimation();
            }
            
            // é–¢æ•°ã®æç”»
            drawFunctions();
            
            // ãƒ©ãƒ™ãƒ«ã®æç”»
            if (showLabels) drawLabels();
        }
        
        // ã‚°ãƒªãƒƒãƒ‰ã®æç”»
        function drawGrid() {
            stroke(230);
            strokeWeight(1 / zoomLevel);
            
            // Xè»¸ã®ã‚°ãƒªãƒƒãƒ‰ç·š
            const xStep = calculateGridStep(xMin, xMax);
            for (let x = Math.floor(xMin / xStep) * xStep; x <= xMax; x += xStep) {
                const screenX = mapX(x);
                line(screenX, 0, screenX, height);
            }
            
            // Yè»¸ã®ã‚°ãƒªãƒƒãƒ‰ç·š
            const yStep = calculateGridStep(yMin, yMax);
            for (let y = Math.floor(yMin / yStep) * yStep; y <= yMax; y += yStep) {
                const screenY = mapY(y);
                line(0, screenY, width, screenY);
            }
        }
        
        // ã‚°ãƒªãƒƒãƒ‰ã‚¹ãƒ†ãƒƒãƒ—ã®è¨ˆç®—
        function calculateGridStep(min, max) {
            const range = max - min;
            const normalizedRange = range / zoomLevel;
            
            if (normalizedRange <= 10) return 0.5;
            if (normalizedRange <= 20) return 1;
            if (normalizedRange <= 50) return 2;
            if (normalizedRange <= 100) return 5;
            return 10;
        }
        
        // è»¸ã®æç”»
        function drawAxes() {
            stroke(0);
            strokeWeight(1.5 / zoomLevel);
            
            // Xè»¸
            const yZero = mapY(0);
            if (yZero >= 0 && yZero <= height) {
                line(0, yZero, width, yZero);
                
                // Xè»¸ã®çŸ¢å°
                const arrowSize = 10 / zoomLevel;
                fill(0);
                triangle(width - 2 * arrowSize, yZero - arrowSize / 2, 
                         width - 2 * arrowSize, yZero + arrowSize / 2, 
                         width - arrowSize, yZero);
            }
            
            // Yè»¸
            const xZero = mapX(0);
            if (xZero >= 0 && xZero <= width) {
                line(xZero, 0, xZero, height);
                
                // Yè»¸ã®çŸ¢å°
                const arrowSize = 10 / zoomLevel;
                fill(0);
                triangle(xZero - arrowSize / 2, arrowSize * 2, 
                         xZero + arrowSize / 2, arrowSize * 2, 
                         xZero, arrowSize);
            }
        }
        
        // ãƒ©ãƒ™ãƒ«ã®æç”»
        function drawLabels() {
            fill(0);
            noStroke();
            textAlign(CENTER, CENTER);
            
            // Xè»¸ã®ãƒ©ãƒ™ãƒ«
            const xStep = calculateGridStep(xMin, xMax);
            const yZero = mapY(0);
            textSize(12 / zoomLevel);
            
            for (let x = Math.floor(xMin / xStep) * xStep; x <= xMax; x += xStep) {
                if (Math.abs(x) < 0.001) continue; // åŸç‚¹ã¯ã‚¹ã‚­ãƒƒãƒ—
                
                const screenX = mapX(x);
                // Xè»¸ãƒ©ãƒ™ãƒ«ã®Yä½ç½®ã‚’èª¿æ•´
                const labelY = yZero + 20 / zoomLevel;
                if (labelY >= 0 && labelY <= height) {
                    text(x.toFixed(1), screenX, labelY);
                }
            }
            
            // Yè»¸ã®ãƒ©ãƒ™ãƒ«
            const yStep = calculateGridStep(yMin, yMax);
            const xZero = mapX(0);
            
            for (let y = Math.floor(yMin / yStep) * yStep; y <= yMax; y += yStep) {
                if (Math.abs(y) < 0.001) continue; // åŸç‚¹ã¯ã‚¹ã‚­ãƒƒãƒ—
                
                const screenY = mapY(y);
                // Yè»¸ãƒ©ãƒ™ãƒ«ã®Xä½ç½®ã‚’èª¿æ•´
                const labelX = xZero - 20 / zoomLevel;
                if (labelX >= 0 && labelX <= width) {
                    text(y.toFixed(1), labelX, screenY);
                }
            }
            
            // åŸç‚¹ãƒ©ãƒ™ãƒ«
            if (xZero >= 0 && xZero <= width && yZero >= 0 && yZero <= height) {
                text("O", xZero - 15 / zoomLevel, yZero + 15 / zoomLevel);
            }
        }
        
        // é–¢æ•°ã®æç”»
        function drawFunctions() {
            functions.forEach((func, index) => {
                if (func.visible) {
                    drawFunction(func, index === selectedFunctionIndex);
                }
            });
        }
        
        // å€‹ã€…ã®é–¢æ•°ã®æç”»
        function drawFunction(func, isSelected) {
            // æç”»ã®ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š
            const strokeColor = color(func.color);
            const fillColor = color(func.color);
            fillColor.setAlpha(50);
            
            // ç·šã®å¤ªã•ã¯é¸æŠçŠ¶æ…‹ã«ã‚ˆã£ã¦å¤‰ã‚ã‚‹
            const lineWeight = isSelected ? 3 / zoomLevel : 2 / zoomLevel;
            
            // é¢ç©å¡—ã‚Šã¤ã¶ã—
            if (func.fillArea) {
                fill(fillColor);
                noStroke();
                beginShape();
                
                // Xè»¸ã®åº§æ¨™
                const yZero = mapY(0);
                vertex(mapX(xMin), yZero);
                
                // é–¢æ•°ã®ç‚¹ã‚’æç”»
                for (let screenX = 0; screenX < width; screenX += 5) {
                    const x = screenToMathX(screenX);
                    if (x < xMin || x > xMax) continue;
                    
                    const y = evaluateFunction(func, x);
                    if (isNaN(y)) continue;
                    
                    const screenY = mapY(y);
                    vertex(screenX, screenY);
                }
                
                vertex(mapX(xMax), yZero);
                endShape(CLOSE);
            }
            
            // é–¢æ•°ã®ç·šã‚’æç”»
            stroke(strokeColor);
            strokeWeight(lineWeight);
            noFill();
            
            beginShape();
            let lastY = null;
            let lastValidX = null;
            let lastValidY = null;
            
            for (let screenX = 0; screenX < width; screenX += 2) {
                const x = screenToMathX(screenX);
                if (x < xMin || x > xMax) continue;
                
                const y = evaluateFunction(func, x);
                if (isNaN(y) || Math.abs(y) > 1000) {
                    // é–¢æ•°ãŒå®šç¾©ã•ã‚Œã¦ã„ãªã„ãƒã‚¤ãƒ³ãƒˆã®å‡¦ç†
                    if (lastY !== null) {
                        endShape();
                        lastY = null;
                    }
                    continue;
                }
                
                // æ€¥æ¿€ãªå¤‰åŒ–ï¼ˆä¸é€£ç¶šç‚¹ï¼‰ã®å‡¦ç†
                if (lastY !== null && Math.abs(y - lastY) > 10) {
                    endShape();
                    beginShape();
                }
                
                const screenY = mapY(y);
                vertex(screenX, screenY);
                lastY = y;
                lastValidX = x;
                lastValidY = y;
            }
            endShape();
            
            // ãƒã‚¤ãƒ³ãƒˆã®æç”»
            if (func.showPoints) {
                fill(strokeColor);
                noStroke();
                
                for (let screenX = 0; screenX < width; screenX += 20) {
                    const x = screenToMathX(screenX);
                    if (x < xMin || x > xMax) continue;
                    
                    const y = evaluateFunction(func, x);
                    if (isNaN(y) || Math.abs(y) > 1000) continue;
                    
                    const screenY = mapY(y);
                    circle(screenX, screenY, 5 / zoomLevel);
                }
            }
            
            // æ¥ç·šã®æç”»
            if (func.showTangent && lastValidX !== null) {
                const x = lastValidX;
                const y = lastValidY;
                
                // å¾®åˆ†ã‚’è¨ˆç®—ã—ã¦æ¥ç·šã®å‚¾ãã‚’æ±‚ã‚ã‚‹
                const h = 0.0001;
                const derivative = (evaluateFunction(func, x + h) - evaluateFunction(func, x - h)) / (2 * h);
                
                // æ¥ç·šã‚’æç”»
                const tangentLength = width / 4 / zoomLevel;
                const x1 = x - tangentLength;
                const y1 = y - derivative * tangentLength;
                const x2 = x + tangentLength;
                const y2 = y + derivative * tangentLength;
                
                stroke(strokeColor);
                strokeWeight(1 / zoomLevel);
                line(mapX(x1), mapY(y1), mapX(x2), mapY(y2));
                
                // æ¥ç‚¹ã‚’å¼·èª¿
                fill(strokeColor);
                noStroke();
                circle(mapX(x), mapY(y), 5 / zoomLevel);
            }
        }
        
        // æ•°å¼ã®è©•ä¾¡
        function evaluateFunction(func, x) {
            try {
                let result;
                
                switch (func.type) {
                    case 'linear':
                        result = func.params.a * x + func.params.b;
                        break;
                    case 'quadratic':
                        result = func.params.a * x * x + func.params.b * x + func.params.c;
                        break;
                    case 'cubic':
                        result = func.params.a * x * x * x + func.params.b * x * x + func.params.c * x + func.params.d;
                        break;
                    case 'sine':
                        result = func.params.a * Math.sin(func.params.b * x + func.params.c) + func.params.d;
                        break;
                    case 'cosine':
                        result = func.params.a * Math.cos(func.params.b * x + func.params.c) + func.params.d;
                        break;
                    case 'exponential':
                        result = func.params.a * Math.exp(func.params.b * x) + func.params.c;
                        break;
                    case 'logarithmic':
                        // è² ã®å€¤ã«ãƒ­ã‚°ã‚’é©ç”¨ã§ããªã„ã®ã§ã€å®šç¾©åŸŸå¤–ãªã‚‰NaNã‚’è¿”ã™
                        if (func.params.b * x <= 0) return NaN;
                        result = func.params.a * Math.log(func.params.b * x) + func.params.c;
                        break;
                    case 'custom':
                        const scope = { x: x };
                        result = math.evaluate(func.expression, scope);
                        break;
                    default:
                        result = x; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯f(x) = x
                }
                
                return result;
            } catch (error) {
                console.error("é–¢æ•°ã®è©•ä¾¡ã‚¨ãƒ©ãƒ¼:", error);
                return NaN;
            }
        }
        
        // Xåº§æ¨™ã®ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆæ•°å­¦ç©ºé–“â†’ç”»é¢ç©ºé–“ï¼‰
        function mapX(x) {
            return map(x, xMin, xMax, 0, width);
        }
        
        // Yåº§æ¨™ã®ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆæ•°å­¦ç©ºé–“â†’ç”»é¢ç©ºé–“ï¼‰
        function mapY(y) {
            return map(y, yMin, yMax, height, 0);
        }
        
        // Xåº§æ¨™ã®ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆç”»é¢ç©ºé–“â†’æ•°å­¦ç©ºé–“ï¼‰
        function screenToMathX(screenX) {
            return map(screenX, 0, width, xMin, xMax);
        }
        
        // Yåº§æ¨™ã®ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆç”»é¢ç©ºé–“â†’æ•°å­¦ç©ºé–“ï¼‰
        function screenToMathY(screenY) {
            return map(screenY, height, 0, yMin, yMax);
        }
        
        // é–¢æ•°ã®è¿½åŠ 
        function addFunction(type = 'linear', params = null, color = null) {
            // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨
            if (!params) {
                params = {};
                const ranges = parameterRanges[type];
                for (const key in ranges) {
                    params[key] = ranges[key].default;
                }
            }
            
            // è‰²ãŒãªã„å ´åˆã¯ãƒªã‚¹ãƒˆã‹ã‚‰é¸æŠ
            if (!color) {
                color = colorList[functions.length % colorList.length];
            }
            
            // é–¢æ•°ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ
            const newFunction = {
                type: type,
                params: params,
                color: color,
                visible: true,
                showPoints: false,
                showTangent: false,
                fillArea: false,
                expression: type === 'custom' ? 'x' : '' // ã‚«ã‚¹ã‚¿ãƒ é–¢æ•°ã®å ´åˆã®ã¿ä½¿ç”¨
            };
            
            functions.push(newFunction);
            return functions.length - 1; // æ–°ã—ã„é–¢æ•°ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¿”ã™
        }
        
        // é–¢æ•°ã®é¸æŠ
        function selectFunction(index) {
            if (index < 0 || index >= functions.length) return;
            
            selectedFunctionIndex = index;
            const func = functions[index];
            
            // UIæ›´æ–°
            document.getElementById('function-type').value = func.type;
            document.getElementById('function-color').value = func.color;
            document.getElementById('show-points').checked = func.showPoints;
            document.getElementById('show-tangent').checked = func.showTangent;
            document.getElementById('fill-area').checked = func.fillArea;
            
            // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®æ›´æ–°
            updateParameterControls();
            
            // ã‚«ã‚¹ã‚¿ãƒ é–¢æ•°ã®å…¥åŠ›æ¬„è¡¨ç¤º/éè¡¨ç¤º
            const customFunctionInput = document.getElementById('custom-function-input');
            if (func.type === 'custom') {
                customFunctionInput.style.display = 'block';
                document.getElementById('custom-expression').value = func.expression;
            } else {
                customFunctionInput.style.display = 'none';
            }
            
            // é–¢æ•°å¼ã®è¡¨ç¤ºæ›´æ–°
            updateFunctionEquation();
            
            // é–¢æ•°ãƒªã‚¹ãƒˆã®æ›´æ–°
            updateFunctionsList();
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®æ›´æ–°
            updateAnimationParameterSelect();
        }
        
        // é–¢æ•°ãƒªã‚¹ãƒˆã®UIæ›´æ–°
        function updateFunctionsList() {
            const listElement = document.getElementById('function-list');
            listElement.innerHTML = '';
            
            functions.forEach((func, index) => {
                const item = document.createElement('div');
                item.className = `function-item${index === selectedFunctionIndex ? ' active' : ''}`;
                
                const typeNames = {
                    linear: 'ä¸€æ¬¡é–¢æ•°',
                    quadratic: 'äºŒæ¬¡é–¢æ•°',
                    cubic: 'ä¸‰æ¬¡é–¢æ•°',
                    sine: 'æ­£å¼¦é–¢æ•°',
                    cosine: 'ä½™å¼¦é–¢æ•°',
                    exponential: 'æŒ‡æ•°é–¢æ•°',
                    logarithmic: 'å¯¾æ•°é–¢æ•°',
                    custom: 'ã‚«ã‚¹ã‚¿ãƒ é–¢æ•°'
                };
                
                item.innerHTML = `
                    <div>
                        <span class="function-color" style="background-color: ${func.color};"></span>
                        <span>${typeNames[func.type] || func.type}</span>
                    </div>
                    <div class="function-actions">
                        <span class="function-action visibility-toggle">${func.visible ? 'ğŸ‘ï¸' : 'ğŸ‘ï¸â€ğŸ—¨ï¸'}</span>
                        <span class="function-action duplicate">ğŸ“‹</span>
                    </div>
                `;
                
                // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
                item.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('function-action')) {
                        selectFunction(index);
                    }
                });
                
                // è¡¨ç¤º/éè¡¨ç¤ºãƒˆã‚°ãƒ«
                const visibilityToggle = item.querySelector('.visibility-toggle');
                visibilityToggle.addEventListener('click', (e) => {
                    func.visible = !func.visible;
                    visibilityToggle.textContent = func.visible ? 'ğŸ‘ï¸' : 'ğŸ‘ï¸â€ğŸ—¨ï¸';
                    e.stopPropagation();
                });
                
                // é–¢æ•°ã‚’è¤‡è£½
                const duplicateButton = item.querySelector('.duplicate');
                duplicateButton.addEventListener('click', (e) => {
                    const newParams = { ...func.params };
                    const newIndex = addFunction(func.type, newParams);
                    
                    if (func.type === 'custom') {
                        functions[newIndex].expression = func.expression;
                    }
                    
                    selectFunction(newIndex);
                    e.stopPropagation();
                });
                
                listElement.appendChild(item);
            });
        }
        
        // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®æ›´æ–°
        function updateParameterControls() {
            if (selectedFunctionIndex === -1) return;
            
            const func = functions[selectedFunctionIndex];
            const controlsContainer = document.getElementById('parameter-controls');
            controlsContainer.innerHTML = '';
            
            // ã‚«ã‚¹ã‚¿ãƒ é–¢æ•°ã®å ´åˆã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’è¡¨ç¤ºã—ãªã„
            if (func.type === 'custom') return;
            
            // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ç¯„å›²å®šç¾©ã‚’å–å¾—
            const ranges = parameterRanges[func.type];
            
            // å„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’ä½œæˆ
            for (const param in ranges) {
                const range = ranges[param];
                const row = document.createElement('div');
                row.className = 'parameter-row';
                
                // ãƒ©ãƒ™ãƒ«
                const label = document.createElement('span');
                label.className = 'parameter-label';
                label.textContent = param;
                row.appendChild(label);
                
                // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
                const slider = document.createElement('input');
                slider.type = 'range';
                slider.className = 'parameter-range';
                slider.min = range.min;
                slider.max = range.max;
                slider.step = range.step;
                slider.value = func.params[param] !== undefined ? func.params[param] : range.default;
                slider.setAttribute('data-param', param);
                
                // å€¤è¡¨ç¤º
                const value = document.createElement('span');
                value.className = 'parameter-value';
                value.textContent = slider.value;
                
                // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
                slider.addEventListener('input', () => {
                    func.params[param] = parseFloat(slider.value);
                    value.textContent = slider.value;
                    updateFunctionEquation();
                });
                
                row.appendChild(slider);
                row.appendChild(value);
                controlsContainer.appendChild(row);
            }
        }
        
        // é–¢æ•°å¼ã®è¡¨ç¤ºæ›´æ–°
        function updateFunctionEquation() {
            if (selectedFunctionIndex === -1) return;
            
            const func = functions[selectedFunctionIndex];
            const equationElement = document.getElementById('function-equation');
            let equation = 'f(x) = ';
            
            switch (func.type) {
                case 'linear':
                    equation += `${func.params.a.toFixed(1)}x ${formatSignedNumber(func.params.b)}`;
                    break;
                case 'quadratic':
                    equation += `${func.params.a.toFixed(1)}xÂ² ${formatSignedNumber(func.params.b)}x ${formatSignedNumber(func.params.c)}`;
                    break;
                case 'cubic':
                    equation += `${func.params.a.toFixed(1)}xÂ³ ${formatSignedNumber(func.params.b)}xÂ² ${formatSignedNumber(func.params.c)}x ${formatSignedNumber(func.params.d)}`;
                    break;
                case 'sine':
                    equation += `${func.params.a.toFixed(1)}Â·sin(${func.params.b.toFixed(1)}x ${formatSignedNumber(func.params.c)}) ${formatSignedNumber(func.params.d)}`;
                    break;
                case 'cosine':
                    equation += `${func.params.a.toFixed(1)}Â·cos(${func.params.b.toFixed(1)}x ${formatSignedNumber(func.params.c)}) ${formatSignedNumber(func.params.d)}`;
                    break;
                case 'exponential':
                    equation += `${func.params.a.toFixed(1)}Â·e^(${func.params.b.toFixed(1)}x) ${formatSignedNumber(func.params.c)}`;
                    break;
                case 'logarithmic':
                    equation += `${func.params.a.toFixed(1)}Â·log(${func.params.b.toFixed(1)}x) ${formatSignedNumber(func.params.c)}`;
                    break;
                case 'custom':
                    equation += func.expression;
                    break;
            }
            
            equationElement.textContent = equation;
        }
        
        // ç¬¦å·ä»˜ãæ•°å­—ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatSignedNumber(num) {
            return num >= 0 ? `+ ${num.toFixed(1)}` : `- ${Math.abs(num).toFixed(1)}`;
        }
        
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®æ›´æ–°
        function updateAnimation() {
            const func = functions[selectedFunctionIndex];
            
            // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ç¯„å›²ã‚’å–å¾—
            const ranges = parameterRanges[func.type];
            if (!ranges || !ranges[animationParameter]) return;
            
            const range = ranges[animationParameter];
            let param = func.params[animationParameter];
            
            // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å¤‰æ›´
            param += animationDirection * 0.02 * animationSpeed;
            
            // ç¯„å›²ã‚’è¶…ãˆãŸã‚‰æ–¹å‘ã‚’åè»¢
            if (param > range.max) {
                param = range.max;
                animationDirection = -1;
            } else if (param < range.min) {
                param = range.min;
                animationDirection = 1;
            }
            
            // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æ›´æ–°
            func.params[animationParameter] = param;
            
            // UIæ›´æ–°
            const slider = document.querySelector(`.parameter-range[data-param="${animationParameter}"]`);
            const valueDisplay = slider?.nextElementSibling;
            if (slider) {
                slider.value = param;
                if (valueDisplay) {
                    valueDisplay.textContent = param.toFixed(2);
                }
            }
            
            // é–¢æ•°å¼ã®æ›´æ–°
            updateFunctionEquation();
        }
        
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®æ›´æ–°
        function updateAnimationParameterSelect() {
            if (selectedFunctionIndex === -1) return;
            
            const func = functions[selectedFunctionIndex];
            const select = document.getElementById('animate-param');
            select.innerHTML = '';
            
            // ã‚«ã‚¹ã‚¿ãƒ é–¢æ•°ã®å ´åˆã¯æ›´æ–°ã—ãªã„
            if (func.type === 'custom') return;
            
            // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ç¯„å›²å®šç¾©ã‚’å–å¾—
            const ranges = parameterRanges[func.type];
            
            // å„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨ã—ã¦è¿½åŠ 
            for (const param in ranges) {
                const option = document.createElement('option');
                option.value = param;
                option.textContent = param;
                select.appendChild(option);
            }
            
            // ç¾åœ¨ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’é¸æŠ
            select.value = animationParameter;
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        function setupEventListeners() {
            // ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã«ã‚ˆã‚‹ã‚ºãƒ¼ãƒ 
            canvas.mouseWheel((event) => {
                const zoomFactor = 1.1;
                const mouseX = mouseX;
                const mouseY = mouseY;
                
                // ãƒã‚¦ã‚¹ä½ç½®ã®æ•°å­¦åº§æ¨™
                const xMath = screenToMathX(mouseX);
                const yMath = screenToMathY(mouseY);
                
                // ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã®æ›´æ–°
                if (event.delta > 0) {
                    zoomLevel /= zoomFactor;
                } else {
                    zoomLevel *= zoomFactor;
                }
                
                // æ¥µç«¯ãªã‚ºãƒ¼ãƒ ã‚’é˜²æ­¢
                zoomLevel = constrain(zoomLevel, 0.1, 10);
                
                // ã‚ºãƒ¼ãƒ å¾Œã‚‚ãƒã‚¦ã‚¹ä½ç½®ãŒåŒã˜æ•°å­¦åº§æ¨™ã‚’æŒ‡ã™ã‚ˆã†ã«èª¿æ•´
                const newXMin = xMath - (xMath - xMin) * zoomFactor;
                const newXMax = xMath + (xMax - xMath) * zoomFactor;
                const newYMin = yMath - (yMath - yMin) * zoomFactor;
                const newYMax = yMath + (yMax - yMath) * zoomFactor;
                
                xMin = newXMin;
                xMax = newXMax;
                yMin = newYMin;
                yMax = newYMax;
                
                // UIæ›´æ–°
                document.getElementById('x-min').value = xMin.toFixed(1);
                document.getElementById('x-max').value = xMax.toFixed(1);
                document.getElementById('y-min').value = yMin.toFixed(1);
                document.getElementById('y-max').value = yMax.toFixed(1);
                
                return false; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²æ­¢
            });
            
            // ãƒã‚¦ã‚¹ãƒ‰ãƒ©ãƒƒã‚°ã«ã‚ˆã‚‹ãƒ‘ãƒ³
            canvas.mousePressed(() => {
                isDragging = true;
                lastMouseX = mouseX;
                lastMouseY = mouseY;
            });
            
            canvas.mouseDragged(() => {
                if (isDragging) {
                    const dx = (mouseX - lastMouseX) / width * (xMax - xMin);
                    const dy = (mouseY - lastMouseY) / height * (yMax - yMin);
                    
                    xMin -= dx;
                    xMax -= dx;
                    yMin += dy;
                    yMax += dy;
                    
                    lastMouseX = mouseX;
                    lastMouseY = mouseY;
                    
                    // UIæ›´æ–°
                    document.getElementById('x-min').value = xMin.toFixed(1);
                    document.getElementById('x-max').value = xMax.toFixed(1);
                    document.getElementById('y-min').value = yMin.toFixed(1);
                    document.getElementById('y-max').value = yMax.toFixed(1);
                }
            });
            
            canvas.mouseReleased(() => {
                isDragging = false;
            });
            
            // ãƒã‚¦ã‚¹ãƒ›ãƒãƒ¼æ™‚ã®ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—
            canvas.mouseMoved(() => {
                const mathX = screenToMathX(mouseX);
                const mathY = screenToMathY(mouseY);
                
                // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã®è¡¨ç¤º
                let nearestFunction = null;
                let nearestDistance = Infinity;
                let nearestY = null;
                
                functions.forEach((func, index) => {
                    if (!func.visible) return;
                    
                    const y = evaluateFunction(func, mathX);
                    if (isNaN(y) || Math.abs(y) > 1000) return;
                    
                    const screenY = mapY(y);
                    const distance = Math.abs(screenY - mouseY);
                    
                    if (distance < 20 && distance < nearestDistance) {
                        nearestDistance = distance;
                        nearestFunction = func;
                        nearestY = y;
                    }
                });
                
                const tooltip = document.getElementById('tooltip');
                
                if (nearestFunction && nearestDistance < 20) {
                    tooltip.style.display = 'block';
                    tooltip.style.left = `${mouseX + 10}px`;
                    tooltip.style.top = `${mouseY - 30}px`;
                    tooltip.innerHTML = `(${mathX.toFixed(2)}, ${nearestY.toFixed(2)})`;
                } else {
                    tooltip.style.display = 'none';
                }
            });
            
            // é–¢æ•°ã‚¿ã‚¤ãƒ—ã®å¤‰æ›´
            document.getElementById('function-type').addEventListener('change', function() {
                if (selectedFunctionIndex === -1) return;
                
                const newType = this.value;
                const oldType = functions[selectedFunctionIndex].type;
                
                // ã‚¿ã‚¤ãƒ—ãŒå¤‰ã‚ã£ãŸå ´åˆã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
                if (newType !== oldType) {
                    functions[selectedFunctionIndex].type = newType;
                    
                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®è¨­å®š
                    if (newType !== 'custom') {
                        const ranges = parameterRanges[newType];
                        const newParams = {};
                        for (const key in ranges) {
                            newParams[key] = ranges[key].default;
                        }
                        functions[selectedFunctionIndex].params = newParams;
                    }
                    
                    // ã‚«ã‚¹ã‚¿ãƒ é–¢æ•°ã®è¡¨ç¤º/éè¡¨ç¤º
                    const customFunctionInput = document.getElementById('custom-function-input');
                    if (newType === 'custom') {
                        customFunctionInput.style.display = 'block';
                        
                        // ã‚«ã‚¹ã‚¿ãƒ é–¢æ•°ã®å¼ãŒã¾ã ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
                        if (!functions[selectedFunctionIndex].expression) {
                            functions[selectedFunctionIndex].expression = 'x';
                        }
                        document.getElementById('custom-expression').value = functions[selectedFunctionIndex].expression;
                    } else {
                        customFunctionInput.style.display = 'none';
                    }
                    
                    // UIæ›´æ–°
                    updateParameterControls();
                    updateFunctionEquation();
                    updateFunctionsList();
                    updateAnimationParameterSelect();
                }
            });
            
            // ã‚«ã‚¹ã‚¿ãƒ é–¢æ•°ã®é©ç”¨
            document.getElementById('apply-custom').addEventListener('click', function() {
                if (selectedFunctionIndex === -1) return;
                
                const expression = document.getElementById('custom-expression').value;
                functions[selectedFunctionIndex].expression = expression;
                updateFunctionEquation();
            });
            
            // é–¢æ•°ã®è‰²å¤‰æ›´
            document.getElementById('function-color').addEventListener('change', function() {
                if (selectedFunctionIndex === -1) return;
                
                functions[selectedFunctionIndex].color = this.value;
                updateFunctionsList();
            });
            
            // è¡¨ç¤ºã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®å¤‰æ›´
            document.getElementById('show-points').addEventListener('change', function() {
                if (selectedFunctionIndex === -1) return;
                functions[selectedFunctionIndex].showPoints = this.checked;
            });
            
            document.getElementById('show-tangent').addEventListener('change', function() {
                if (selectedFunctionIndex === -1) return;
                functions[selectedFunctionIndex].showTangent = this.checked;
            });
            
            document.getElementById('fill-area').addEventListener('change', function() {
                if (selectedFunctionIndex === -1) return;
                functions[selectedFunctionIndex].fillArea = this.checked;
            });
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åˆ¶å¾¡
            document.getElementById('animate-button').addEventListener('click', function() {
                if (selectedFunctionIndex === -1) return;
                
                isAnimating = true;
                animationParameter = document.getElementById('animate-param').value;
                animationSpeed = parseFloat(document.getElementById('animation-speed').value);
            });
            
            document.getElementById('stop-animation').addEventListener('click', function() {
                isAnimating = false;
            });
            
            document.getElementById('animation-speed').addEventListener('input', function() {
                animationSpeed = parseFloat(this.value);
            });
            
            document.getElementById('animate-param').addEventListener('change', function() {
                animationParameter = this.value;
            });
            
            // ç¯„å›²ã®é©ç”¨
            document.getElementById('apply-range').addEventListener('click', function() {
                xMin = parseFloat(document.getElementById('x-min').value);
                xMax = parseFloat(document.getElementById('x-max').value);
                yMin = parseFloat(document.getElementById('y-min').value);
                yMax = parseFloat(document.getElementById('y-max').value);
                
                // å€¤ãŒä¸æ­£ãªå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™
                if (xMin >= xMax) {
                    xMin = -10;
                    xMax = 10;
                    document.getElementById('x-min').value = xMin;
                    document.getElementById('x-max').value = xMax;
                }
                
                if (yMin >= yMax) {
                    yMin = -10;
                    yMax = 10;
                    document.getElementById('y-min').value = yMin;
                    document.getElementById('y-max').value = yMax;
                }
            });
            
            // è¡¨ç¤ºã®åˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('toggleGrid').addEventListener('click', function() {
                showGrid = !showGrid;
                this.classList.toggle('active', showGrid);
            });
            
            document.getElementById('toggleAxes').addEventListener('click', function() {
                showAxes = !showAxes;
                this.classList.toggle('active', showAxes);
            });
            
            document.getElementById('toggleLabels').addEventListener('click', function() {
                showLabels = !showLabels;
                this.classList.toggle('active', showLabels);
            });
            
            document.getElementById('resetView').addEventListener('click', function() {
                xMin = -10;
                xMax = 10;
                yMin = -10;
                yMax = 10;
                zoomLevel = 1;
                
                document.getElementById('x-min').value = xMin;
                document.getElementById('x-max').value = xMax;
                document.getElementById('y-min').value = yMin;
                document.getElementById('y-max').value = yMax;
            });
            
            // é–¢æ•°ã®è¿½åŠ ã¨å‰Šé™¤
            document.getElementById('add-function').addEventListener('click', function() {
                const newIndex = addFunction();
                selectFunction(newIndex);
                updateFunctionsList();
            });
            
            document.getElementById('remove-function').addEventListener('click', function() {
                if (selectedFunctionIndex === -1) return;
                if (functions.length <= 1) {
                    alert('å°‘ãªãã¨ã‚‚1ã¤ã®é–¢æ•°ãŒå¿…è¦ã§ã™ã€‚');
                    return;
                }
                
                functions.splice(selectedFunctionIndex, 1);
                
                // é¸æŠä¸­ã®é–¢æ•°ãŒå‰Šé™¤ã•ã‚ŒãŸå ´åˆã¯æœ€å¾Œã®é–¢æ•°ã‚’é¸æŠ
                if (selectedFunctionIndex >= functions.length) {
                    selectedFunctionIndex = functions.length - 1;
                }
                
                selectFunction(selectedFunctionIndex);
                updateFunctionsList();
            });
        }
        
        // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºæ™‚ã®å‡¦ç†
        function windowResized() {
            const canvasContainer = document.getElementById('canvas-container');
            resizeCanvas(canvasContainer.offsetWidth, canvasContainer.offsetHeight);
        }
    </script>
</body>
</html>